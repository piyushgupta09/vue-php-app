<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listings Management</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div id="app">
        <h1>Listings</h1>
        <add-listing-component @add-listing="addListing"></add-listing-component>
        <listings-component :listings="listings" @edit-listing="editListing" @delete-listing="deleteListing"></listings-component>
        <edit-listing-component :current-listing="currentListing" :editing="editing" @update-listing="updateListing" @cancel-edit="cancelEdit"></edit-listing-component>
    </div>

    <script>
        Vue.component('add-listing-component', {
            template: `
                <form @submit.prevent="addListing">
                    <input v-model="newListing.title" placeholder="Title" required>
                    <input v-model="newListing.description" placeholder="Description">
                    <input v-model="newListing.price" type="number" placeholder="Price" required>
                    <button type="submit">Add Listing</button>
                </form>
            `,
            data() {
                return {
                    newListing: {
                        title: '',
                        description: '',
                        price: ''
                    }
                };
            },
            methods: {
                addListing() {
                    this.$emit('add-listing', this.newListing);
                    this.newListing = { title: '', description: '', price: '' };
                }
            }
        });

        Vue.component('listings-component', {
            template: `
                <ul>
                    <li v-for="listing in listings" :key="listing.id">
                        {{ listing.title }} - {{ listing.price }}
                        <button @click="$emit('edit-listing', listing)">Edit</button>
                        <button @click="$emit('delete-listing', listing.id)">Delete</button>
                    </li>
                </ul>
            `,
            props: ['listings']
        });

        Vue.component('edit-listing-component', {
            template: `
                <div v-if="editing">
                    <h2>Edit Listing</h2>
                    <form @submit.prevent="updateListing">
                        <input v-model="currentListing.title" placeholder="Title" required>
                        <input v-model="currentListing.description" placeholder="Description">
                        <input v-model="currentListing.price" type="number" placeholder="Price" required>
                        <button type="submit">Update Listing</button>
                        <button @click="$emit('cancel-edit')">Cancel</button>
                    </form>
                </div>
            `,
            props: ['currentListing', 'editing'],
            methods: {
                updateListing() {
                    this.$emit('update-listing', this.currentListing);
                }
            }
        });

        new Vue({
            el: '#app',
            data: {
                listings: [],
                currentListing: {
                    id: '',
                    title: '',
                    description: '',
                    price: ''
                },
                editing: false
            },
            created() {
                this.fetchListings();
            },
            methods: {
                fetchListings() {
                    axios.get('/api', {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => {
                        this.listings = response.data;
                    })
                    .catch(error => {
                        console.error('Error fetching listings:', error);
                    });
                },
                addListing(newListing) {
                    axios.post('/api', newListing, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        }
                    })
                    .then(() => {
                        this.fetchListings();
                    })
                    .catch(error => {
                        console.error('Error adding listing:', error);
                    });
                },
                editListing(listing) {
                    this.editing = true;
                    this.currentListing = { ...listing };
                },
                updateListing() {
                    axios.put('/api', this.currentListing, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        }
                    })
                    .then(() => {
                        this.fetchListings();
                        this.editing = false;
                        this.currentListing = { id: '', title: '', description: '', price: '' };
                    })
                    .catch(error => {
                        console.error('Error updating listing:', error);
                    });
                },
                deleteListing(id) {
                    axios.delete('/api', {
                        data: { id },
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        }
                    })
                    .then(() => {
                        this.fetchListings();
                    })
                    .catch(error => {
                        console.error('Error deleting listing:', error);
                    });
                },
                cancelEdit() {
                    this.editing = false;
                    this.currentListing = { id: '', title: '', description: '', price: '' };
                }
            }
        });
    </script>
</body>
</html>